<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.12.0/lib/theme-chalk/index.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda">eruda.init();</script>
    <script src="https://unpkg.com/element-ui@2.12.0/lib/index.js"></script>
    <script src="./dist/WebRTCService.min.js"></script>
    <style>
        .test-panel {
            margin-left: 8px;
            margin-top: 8px;
        }

        .good-btn {
            font-size: 18px;
        }
    </style>
</head>

<body>
    <div id="app" class="test-panel">
        <el-card class="box-card">
            <div>
                <p style="margin: 0;">ä¸Šè¡Œ å‘é€ç ç‡ï¼š{{brSend}} | RTTï¼š{{rtt}}</p>
                <!-- ç¼–ç å™¨ï¼š{{codecName}} | é‡‡æ ·ç‡ï¼š{{sampleRate}} | å£°é“ï¼š{{numChannel}} | ä¸¢åŒ…æ•°ï¼š æ”¶åŒ…æ•°ï¼š ä¸¢åŒ…ç‡ï¼š{{pkgLossRate}}-->
                <p style="margin: 0;" v-for="dsi in downStreamInfoList">ä¸‹è¡Œ{{dsi.uin}} æ¥æ”¶ç ç‡ï¼š{{dsi.brRecv}} |
                    å»¶è¿Ÿï¼š{{dsi.delay}} |
                    æŠ–åŠ¨msï¼š{{dsi.jitterBufferMs}} | æŠ–åŠ¨cï¼š{{dsi.jitterReceived}}</p>
                <p></p>
                <el-alert style="width:600px" title="èŠå¤©å®¤å°šæœªå¼€å‘æƒé™ç³»ç»Ÿï¼Œè¯·å’Œæ‚¨çš„å¥½å‹çº¦å®šå¥½é¿å…å¤šäººåŒæ—¶å‘è¨€ã€‚" type="info" close-text="æˆ‘çŸ¥é“äº†~">
                </el-alert>
                <el-divider></el-divider>
                <span>æˆ¿é—´å·ï¼š</span>
                <el-input v-model="roomId" :disabled='inRoom' style="width:200px"></el-input>
                <span style="color:#999;font-size: 14px;">è¯·è¾“å…¥çº¯æ•°å­—</span>
                <p></p>
                <span>æ‰¬å£°å™¨ï¼š</span>
                <el-switch v-model="speakerStatus" :disabled='!inRoom' @change="handleSpeaker" active-text="å¼€å¯"
                    inactive-text="ğŸ”ˆå…³é—­">
                </el-switch>
                <p></p>
                <span>éº¦å…‹é£ï¼š</span>
                <el-switch v-model="micStatus" :disabled='!inRoom' @change="handleMic" active-text="å¼€å¯"
                    inactive-text="ğŸ™å…³é—­">
                </el-switch>
                <p>éº¦å…‹é£éŸ³é‡ï¼š</p>
                <el-slider v-model="volume" style="width:400px" @change="changeVolume">
                </el-slider>
                <br>
                <el-button type='success' :disabled='inRoom' @click="joinRoom">è¿›å…¥æˆ¿é—´</el-button>
                <el-button type="danger" :disabled='!inRoom' @click="exitRoom">é€€å‡ºæˆ¿é—´</el-button>

            </div>
        </el-card>
    </div>
    <div id="gme-audio-wrap"></div>
    <script>


        function genRandNumId() {
            return Number(Math.random() * 1000 * 1000 * 1000 * 10)
                .toFixed(0);
        }

        const LocalDebugAuth = false;

        let gmeAPI = new WebGMEAPI();


        var app = new Vue({
            el: '#app',
            data: {
                brSend: '?',
                rtt: '?',
                value1: '',
                value2: '',
                inRoom: false,
                sdkAppId: 1400284087,
                roomId: 10086,
                openId: genRandNumId(),
                speakerStatus: false,
                micStatus: false,
                volume: 20,
                FetchSigCgi: 'https://www.zhangpeng2k.com/chat-serve',
                downStreamInfoList: [{
                    brRecv: '?',
                    delay: '?',
                    jitterBufferMs: '?',
                    jitterReceived: '?'
                }]
            },
            methods: {
                joinRoom() {
                    var that = this

                    $.ajax({
                        type: "POST",
                        url: that.FetchSigCgi,
                        dataType: 'json',
                        data: {
                            sdkappid: this.sdkAppId,
                            roomid: this.roomId,
                            openid: this.openId,
                        },
                        success: function (json) {
                            //æ­¥éª¤2, è·å–AuthBufferæˆåŠŸ
                            if (json && json.errorCode === 0) {
                                let userSig = json.userSig;
                                that.initGMEWithSig(userSig)
                            } else {
                                console.error(json);
                            }
                        },
                        error: function (err) {
                            console.error(err);
                        }
                    });
                },
                exitRoom() {
                    gmeAPI.ExitRoom();
                },
                initGMEWithSig(userSig) {
                    gmeAPI.Init(document, this.sdkAppId, this.openId);
                    gmeAPI.SetTMGDelegate(this.onEvent);
                    gmeAPI.EnterRoom(this.roomId, 1, userSig);

                },
                changeVolume(val) {
                    gmeAPI.SetMicVolume(val);
                },
                handleSpeaker(val) {
                    gmeAPI.EnableSpeaker(val);
                },
                handleMic(val) {
                    gmeAPI.EnableMic(val);
                },
                onEvent(eventType, result) {
                    if (eventType === gmeAPI.event.ITMG_MAIN_EVENT_TYPE_ENTER_ROOM) {
                        // alert("EnterRoom");
                        this.$message({
                            type: 'success',
                            message: 'å·²è¿›å…¥æˆ¿é—´ï¼'
                        })
                        this.inRoom = true
                        gmeAPI.SetMicVolume(this.volume);
                    }
                    else if (eventType === gmeAPI.event.ITMG_MAIN_EVNET_TYPE_USER_UPDATE) {
                        this.downStreamInfoList = result.PeerInfo;
                        this.brSend = result.UploadBRSend;
                        this.rtt = result.UploadRTT;
                        console.log(result);
                        
                    }
                    else if (eventType === gmeAPI.event.ITMG_MAIN_EVENT_TYPE_EXIT_ROOM) {
                        this.$message({
                            type: 'info',
                            message: 'å·²é€€å‡ºæˆ¿é—´ï¼'
                        })
                        this.inRoom = false
                    }
                    else if (eventType === gmeAPI.event.ITMG_MAIN_EVENT_TYPE_ROOM_DISCONNECT) {
                        this.$message({
                            type: 'info',
                            message: 'Room Disconnect!!!'
                        })
                    }
                }
            },
            mounted() {
                this.$notify({
                    title: 'ä½¿ç”¨æç¤º',
                    type: 'info',
                    dangerouslyUseHTMLString: true,
                    message: '<p>1. è¾“å…¥æˆ¿é—´å·</p><p>2. ç‚¹å‡»åŠ å…¥æˆ¿é—´æŒ‰é’®<p>3. å¼€å¯æ‰¬å£°å™¨,å¼€å¯éº¦å…‹é£</p>',
                    duration: 0
                });
            }
        });
    </script>
</body>

</html>